-- Khai b√°o c√°c service c·∫ßn thi·∫øt
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local VirtualUser = game:GetService("VirtualUser")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- Ch·∫∑n AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- T·ª± ƒë·ªông ch·ªçn H·∫£i T·∫∑c khi v√†o game
if game.PlaceId == 2753915549 or game.PlaceId == 4442272183 or game.PlaceId == 7449423635 then
    local args = { [1] = "SetTeam", [2] = "Pirates" }
    ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args))
    wait(1)
    ReplicatedStorage.Remotes.CommF_:InvokeServer("TeleportToSpawn")
end

-- H√†m hi·ªÉn th·ªã UI th√¥ng b√°o v·ªõi hi·ªáu ·ª©ng m·ªü t·ª´ d∆∞·ªõi l√™n
local function CreateUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PlowHubUI"
    screenGui.Parent = game.Players.LocalPlayer:FindFirstChild("PlayerGui") or game.CoreGui

    local Frame = Instance.new("Frame", screenGui)
    Frame.Size = UDim2.new(0, 320, 0, 200)
    Frame.Position = UDim2.new(0.5, -160, 1, 0)  -- Ban ƒë·∫ßu ƒë·∫∑t ·ªü d∆∞·ªõi c√πng c·ªßa m√†n h√¨nh
    Frame.BackgroundColor3 = Color3.new(0, 0, 0)
    Frame.BackgroundTransparency = 0.3
    Frame.BorderSizePixel = 2
    Frame.BorderRadius = UDim.new(0, 16)  -- Bo tr√≤n g√≥c

    -- Ti√™u ƒë·ªÅ
    local Title = Instance.new("TextLabel", Frame)
    Title.Size = UDim2.new(1, 0, 0.2, 0)
    Title.Text = "üåê Plow Game | Community"
    Title.TextScaled = true
    Title.TextColor3 = Color3.new(1, 1, 1)
    Title.BackgroundTransparency = 1

    -- Tr·∫°ng th√°i l∆∞u tr·ªØ tr√°i
    local StatusLabel = Instance.new("TextLabel", Frame)
    StatusLabel.Size = UDim2.new(1, 0, 0.3, 0)
    StatusLabel.Position = UDim2.new(0, 0, 0.2, 0)
    StatusLabel.Text = "üîé ƒêang ki·ªÉm tra tr√°i √°c qu·ª∑..."
    StatusLabel.TextScaled = true
    StatusLabel.TextColor3 = Color3.new(1, 1, 1)
    StatusLabel.BackgroundTransparency = 1

    -- B·ªô ƒë·∫øm th·ªùi gian chuy·ªÉn server
    local TimerLabel = Instance.new("TextLabel", Frame)
    TimerLabel.Size = UDim2.new(1, 0, 0.15, 0)
    TimerLabel.Position = UDim2.new(0, 0, 0.55, 0)
    TimerLabel.Text = "‚è≥ Chuy·ªÉn server sau: 5s"
    TimerLabel.TextScaled = true
    TimerLabel.TextColor3 = Color3.new(0, 1, 0)
    TimerLabel.BackgroundTransparency = 1

    -- Tween ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng m·ªü UI t·ª´ d∆∞·ªõi l√™n
    local tweenService = game:GetService("TweenService")
    local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    local goal = { Position = UDim2.new(0.5, -160, 0.05, 0) }

    local tween = tweenService:Create(Frame, tweenInfo, goal)
    tween:Play()

    return StatusLabel, TimerLabel
end

-- Kh·ªüi t·∫°o UI
local StatusLabel, TimerLabel = CreateUI()

-- H√†m t√¨m tr√°i √°c qu·ª∑
local function FindFruit()
    for _, fruit in pairs(game.Workspace:GetChildren()) do
        if fruit:IsA("Tool") and string.find(fruit.Name, "Fruit") then
            return fruit
        end
    end
    return nil
end

-- H√†m l∆∞u tr·ªØ tr√°i v√†o kho
local function StoreFruit(fruit)
    local success, message = pcall(function()
        -- G·ªçi l·ªánh l∆∞u tr·ªØ v√†o kho
        ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", fruit.Name)
    end)

    -- Ki·ªÉm tra n·∫øu l∆∞u th√†nh c√¥ng
    if success then
        StatusLabel.Text = "‚úÖ ƒê√£ l∆∞u tr·ªØ tr√°i " .. fruit.Name .. " v√†o kho!"
        print("Tr√°i " .. fruit.Name .. " ƒë√£ ƒë∆∞·ª£c l∆∞u tr·ªØ v√†o kho!")
        return true
    else
        StatusLabel.Text = "‚ùå L·ªói khi l∆∞u tr·ªØ tr√°i: " .. message
        print("L·ªói khi l∆∞u tr·ªØ tr√°i: " .. message)
        return false
    end
end

-- H√†m ki·ªÉm tra tr√°i ƒë√£ ƒë∆∞·ª£c l∆∞u tr·ªØ v√†o kho ch∆∞a (ki·ªÉm tra r∆∞∆°ng)
local function CheckFruitInStorage(fruitName)
    local success, storedFruits = pcall(function()
        -- Gi·∫£ s·ª≠ ch√∫ng ta c√≥ th·ªÉ truy xu·∫•t danh s√°ch tr√°i ƒë√£ l∆∞u t·ª´ m·ªôt server ho·∫∑c d·ªãch v·ª•
        return ReplicatedStorage.Remotes.CommF_:InvokeServer("GetStoredFruits")
    end)

    if success then
        -- Ki·ªÉm tra xem tr√°i ƒë√£ ƒë∆∞·ª£c l∆∞u ch∆∞a
        for _, storedFruit in pairs(storedFruits) do
            if storedFruit == fruitName then
                return true
            end
        end
    end
    return false
end

-- H√†m ƒë·ªÉ b·∫Øt ƒë·∫ßu quy tr√¨nh chuy·ªÉn server v√† ki·ªÉm tra tr√°i √°c qu·ª∑
local function StartServerSwitch()
    while true do
        -- Ki·ªÉm tra tr√°i √°c qu·ª∑ c√≥ s·∫µn kh√¥ng
        local fruit = FindFruit()
        if fruit then
            -- N·∫øu t√¨m th·∫•y tr√°i, nh·∫∑t v√† l∆∞u tr·ªØ
            LocalPlayer.Character.Humanoid:EquipTool(fruit)

            -- L∆∞u tr√°i v√†o kho v√† ki·ªÉm tra l∆∞u th√†nh c√¥ng
            local stored = StoreFruit(fruit)
            if stored then
                -- Ki·ªÉm tra n·∫øu tr√°i ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o kho th√†nh c√¥ng
                local success = CheckFruitInStorage(fruit.Name)
                if success then
                    print("Tr√°i " .. fruit.Name .. " ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o kho th√†nh c√¥ng!")
                    StatusLabel.Text = "‚úÖ Tr√°i " .. fruit.Name .. " ƒë√£ l∆∞u v√†o kho!"
                else
                    print("Tr√°i " .. fruit.Name .. " kh√¥ng th·ªÉ l∆∞u tr·ªØ v√†o kho!")
                    StatusLabel.Text = "‚ùå L·ªói l∆∞u tr√°i " .. fruit.Name
                end
            end
        else
            -- N·∫øu kh√¥ng c√≥ tr√°i, th·ª±c hi·ªán chuy·ªÉn server
            local countdown = 5
            for i = countdown, 1, -1 do
                TimerLabel.Text = "‚è≥ Chuy·ªÉn server sau: " .. i .. "s"
                wait(1)
            end
            -- Sau ƒë·∫øm ng∆∞·ª£c, th·ª±c hi·ªán chuy·ªÉn server
            StatusLabel.Text = "üîÑ ƒêang chuy·ªÉn server..."
            TimerLabel.Text = "‚è≥ ƒêang chuy·ªÉn server..."
            -- D√πng TeleportService ƒë·ªÉ chuy·ªÉn server
            TeleportService:Teleport(game.PlaceId, LocalPlayer)
        end
        wait(5) -- Ch·ªù 5 gi√¢y tr∆∞·ªõc khi ki·ªÉm tra l·∫°i
    end
end

-- B·∫Øt ƒë·∫ßu quy tr√¨nh chuy·ªÉn server
StartServerSwitch()
