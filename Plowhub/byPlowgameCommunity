repeat wait() until game:IsLoaded()
wait(1)

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- 🔥 Tự động nhận diện executor
local executor = identifyexecutor and identifyexecutor() or "Unknown"
print("🔎 Đang chạy trên Executor: " .. executor)

-- 🏴 Fix Join Team Pirates (Chắc chắn vào Team)
local function selectPirateTeam()
    if LocalPlayer.Team and LocalPlayer.Team.Name == "Pirates" then
        return
    end

    local remote = ReplicatedStorage:WaitForChild("Remotes", 5)
    if remote then
        local teamSelect = remote:FindFirstChild("TeamSelect")
        if teamSelect then
            for attempt = 1, 10 do
                if LocalPlayer.Team and LocalPlayer.Team.Name == "Pirates" then
                    print("✅ Đã vào Team Pirates!")
                    return
                end

                print("🔄 Thử vào Team Pirates... (Lần " .. attempt .. ")")
                teamSelect:InvokeServer("Pirates")
                wait(2)
            end
        end
    end

    warn("⚠️ Lỗi vào team! Đang reset nhân vật để thử lại...")
    LocalPlayer.Character:BreakJoints()
    wait(5)
    selectPirateTeam()
end

selectPirateTeam() -- Chạy trước khi UI xuất hiện

-- 🛡 Anti Ban (Plow Anti-Ban)
local function antiBan()
    if setfflag then
        setfflag("HumanoidParallelRemoveNoPhysics", "False")
        setfflag("HumanoidParallelRemoveNoPhysicsNoSimulate2", "False")
        setfflag("CrashPadUploadToBacktraceToBacktraceBaseUrl", "")
    end

    if setscriptable then
        setscriptable(game, "HttpGet", false)
        setscriptable(game, "HttpPost", false)
    end

    print("🛡 Anti Ban Đã Kích Hoạt!")
end

antiBan()

-- 🎮 Hỗ trợ PE (Mobile Executor)
if executor == "Fluxus" or executor == "Hydrogen" or executor == "Arceus X" then
    getgenv = function() return _G end -- Fix lỗi KRNL/PE không có getgenv
end

-- 🚀 Giữ FPS ổn định cho Mobile & Low-End PC
if setfpscap then
    setfpscap(30) -- Giữ FPS ổn định
end

-- 🔍 Tìm fruit gần nhất
local function findNearestFruit()
    for _, fruit in pairs(Workspace:GetChildren()) do
        if fruit:IsA("Model") and fruit.Name:find("Fruit") and fruit:FindFirstChild("Handle") then
            return fruit
        end
    end
    return nil
end

-- 🚀 Tự động bay đến fruit bằng TweenService
local function teleportToFruit(fruit)
    if fruit and fruit:FindFirstChild("Handle") and LocalPlayer.Character then
        local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            local goal = {CFrame = fruit.Handle.CFrame}
            local tweenInfo = TweenInfo.new(2, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
            local tween = TweenService:Create(rootPart, tweenInfo, goal)
            tween:Play()
            tween.Completed:Wait()
        end
    end
end

-- 📦 Lưu trữ fruit vào inventory
local function storeFruitInInventory(fruit)
    if fruit and fruit:FindFirstChild("Handle") then
        local args = {
            [1] = fruit.Name,
            [2] = fruit.Handle.Position
        }
        
        local maxAttempts = 5
        local attempt = 0
        local success = false
        
        while attempt < maxAttempts do
            local successCall, result = pcall(function()
                return ReplicatedStorage.Remotes:FindFirstChild("StoreFruit"):InvokeServer(unpack(args))
            end)

            if successCall then
                success = true
                break
            else
                attempt = attempt + 1
                warn("[StoreFruit]: Thử lần " .. attempt .. " thất bại! Đang thử lại...")
                wait(1)
            end
        end

        return success
    end
    return false
end

-- 🔄 Đổi server sau 5 giây nếu lưu fruit thành công
local function switchServer()
    for i = 5, 1, -1 do
        print("🔄 Đổi server sau: " .. i .. " giây")
        wait(1)
    end

    TeleportService:Teleport(game.PlaceId, LocalPlayer)
end

-- 📌 Kiểm tra & Nhặt Fruit
local function checkAndPickFruit()
    local fruit = findNearestFruit()

    if fruit then
        print("✅ Đã Tìm Thấy Fruit! " .. fruit.Name)
        teleportToFruit(fruit)
        wait(1)
        local stored = storeFruitInInventory(fruit)
        
        if stored then
            print("📦 Đã lưu trữ fruit vào kho!")
            switchServer()
        else
            print("⚠️ Không thể lưu trữ fruit! Đang tìm server mới...")
            switchServer()
        end
    else
        print("❌ Không có fruit!")
        switchServer()
    end
end

checkAndPickFruit()
